"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ Asterisk –∏–∑ –ë–î
"""
import subprocess
from pathlib import Path
from typing import List, Optional
from loguru import logger
from sqlalchemy.orm import Session

from ..models.company import Company
from ..models.sip_trunk import SIPTrunk
from ..models.phone_number import PhoneNumber
from ..models.user import User
from ..config import get_settings

settings = get_settings()


class AsteriskConfigGenerator:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã Asterisk –∏–∑ –ë–î"""
    
    def __init__(self, config_path: str = "/etc/asterisk/dynamic"):
        self.config_path = Path(config_path)
        self.pjsip_config_file = self.config_path / "pjsip_dynamic.conf"
        self.extensions_config_file = self.config_path / "extensions_dynamic.conf"
    
    def generate_all_configs(self, db: Session) -> dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        
        Returns:
            dict: –°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
            companies = db.query(Company).filter(Company.is_active == True).all()
            users = db.query(User).filter(User.is_active == True).all()
            trunks = db.query(SIPTrunk).filter(SIPTrunk.enabled == True).all()
            phone_numbers = db.query(PhoneNumber).filter(PhoneNumber.is_available == True).all()
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥–∏
            # –í–ê–ñ–ù–û: SIP —Ç—Ä–∞–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤ pjsip_mango.conf, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ WebRTC –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
            pjsip_content = self._generate_pjsip_config(companies, users, [], phone_numbers)  # –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∫–æ–≤
            extensions_content = self._generate_extensions_config(companies, users, trunks, phone_numbers)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã
            self._save_config(self.pjsip_config_file, pjsip_content)
            self._save_config(self.extensions_config_file, extensions_content)
            
            logger.info(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã")
            logger.info(f"   - {self.pjsip_config_file}")
            logger.info(f"   - {self.extensions_config_file}")
            
            return {
                "status": "success",
                "files": [
                    str(self.pjsip_config_file),
                    str(self.extensions_config_file)
                ],
                "stats": {
                    "companies": len(companies),
                    "users": len(users),
                    "trunks": len(trunks),
                    "phone_numbers": len(phone_numbers)
                }
            }
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤: {e}")
            raise
    
    def _generate_pjsip_config(
        self, 
        companies: List[Company], 
        users: List[User], 
        trunks: List[SIPTrunk],
        phone_numbers: List[PhoneNumber]
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç pjsip.conf"""
        
        lines = [
            ";",
            "; PJSIP Configuration - Auto-generated from Database",
            "; DO NOT EDIT MANUALLY - Changes will be overwritten",
            ";",
            "; Generated by AI Call Agent",
            ";",
            ""
        ]
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (WebRTC endpoints)
        lines.append("; ========================================")
        lines.append("; WebRTC Operators")
        lines.append("; ========================================")
        lines.append("")
        
        for user in users:
            if not user.sip_username:
                continue
                
            company = next((c for c in companies if c.id == user.company_id), None)
            if not company:
                continue
            
            # Endpoint
            lines.extend([
                f"[{user.sip_username}]",
                "type=endpoint",
                f"context=company_{company.id}",
                "disallow=all",
                "allow=opus",
                "allow=ulaw",
                "webrtc=yes",
                "transport=transport-ws",
                f"auth={user.sip_username}-auth",
                f"aors={user.sip_username}",
                "direct_media=no",
                "ice_support=yes",
                "media_encryption=dtls",
                "dtls_verify=fingerprint",
                "dtls_auto_generate_cert=yes",
                "dtls_setup=actpass",
                "dtls_rekey=0",
                "rtcp_mux=yes",
                "use_avpf=yes",
                "force_avp=no",
                "rtp_symmetric=yes",
                "force_rport=yes",
                "rewrite_contact=yes",
                ""
            ])
            
            # Auth
            lines.extend([
                f"[{user.sip_username}-auth]",
                "type=auth",
                "auth_type=userpass",
                f"username={user.sip_username}",
                f"password={user.sip_password}",
                "realm=asterisk",
                ""
            ])
            
            # AOR
            lines.extend([
                f"[{user.sip_username}]",
                "type=aor",
                "max_contacts=5",
                "remove_existing=yes",
                "",
                ""
            ])
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è SIP —Ç—Ä–∞–Ω–∫–æ–≤
        lines.append("; ========================================")
        lines.append("; SIP Trunks")
        lines.append("; ========================================")
        lines.append("")
        
        for trunk in trunks:
            company = next((c for c in companies if c.id == trunk.company_id), None)
            if not company:
                continue
            
            trunk_name = f"trunk_{trunk.id}_{trunk.provider}"
            
            # Registration
            lines.extend([
                f"[{trunk_name}-reg]",
                "type=registration",
                f"server_uri={trunk.server_uri}",
                f"client_uri={trunk.client_uri}",
                f"contact_user={trunk.username}",
                f"outbound_auth={trunk_name}-auth",
                "retry_interval=60",
                "forbidden_retry_interval=600",
                "max_retries=10",
                "auth_rejection_permanent=yes",
                f"line=yes",
                f"endpoint={trunk_name}",
                ""
            ])
            
            # Auth
            lines.extend([
                f"[{trunk_name}-auth]",
                "type=auth",
                "auth_type=userpass",
                f"username={trunk.username}",
                f"password={trunk.password}",
                f"realm={trunk.realm}",
                ""
            ])
            
            # Endpoint
            lines.extend([
                f"[{trunk_name}]",
                "type=endpoint",
                f"context=from_trunk_{trunk.id}",
                "disallow=all",
                "allow=ulaw",
                "allow=alaw",
                "allow=opus",
                "transport=transport-udp",
                f"outbound_auth={trunk_name}-auth",
                f"aors={trunk_name}",
                "from_user=${CALLERID(num)}",
                "rtp_symmetric=yes",
                "force_rport=yes",
                "rewrite_contact=yes",
                "send_rpid=yes",
                "direct_media=no",
                ""
            ])
            
            # AOR
            lines.extend([
                f"[{trunk_name}]",
                "type=aor",
                f"contact={trunk.server_uri}",
                "qualify_frequency=60",
                ""
            ])
            
            # Identify (–¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤)
            if trunk.realm:
                lines.extend([
                    f"[{trunk_name}-identify]",
                    "type=identify",
                    f"endpoint={trunk_name}",
                    f"match={trunk.realm}",
                    "",
                    ""
                ])
        
        return "\n".join(lines)
    
    def _generate_extensions_config(
        self, 
        companies: List[Company], 
        users: List[User], 
        trunks: List[SIPTrunk],
        phone_numbers: List[PhoneNumber]
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç extensions.conf (dialplan)"""
        
        lines = [
            ";",
            "; Dialplan - Auto-generated from Database",
            "; DO NOT EDIT MANUALLY - Changes will be overwritten",
            ";",
            "; Generated by AI Call Agent",
            ";",
            ""
        ]
        
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
        for company in companies:
            company_users = [u for u in users if u.company_id == company.id]
            company_trunks = [t for t in trunks if t.company_id == company.id]
            
            if not company_users:
                continue
            
            lines.append(f"; ========================================")
            lines.append(f"; Company: {company.name} (ID: {company.id})")
            lines.append(f"; ========================================")
            lines.append("")
            
            # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏
            lines.append(f"[company_{company.id}]")
            
            # –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞
            lines.extend([
                "; –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞",
                "exten => 100,1,Answer()",
                "same => n,Playback(demo-echotest)",
                "same => n,Echo()",
                "same => n,Hangup()",
                "",
                "exten => 101,1,Answer()",
                "same => n,SayDigits(${EPOCH})",
                "same => n,Hangup()",
                "",
            ])
            
            # –ó–≤–æ–Ω–∫–∏ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–∞–Ω–∏–∏
            lines.append("; –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–≤–æ–Ω–∫–∏ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏")
            for user in company_users:
                if user.sip_username:
                    lines.extend([
                        f"exten => {user.sip_username},1,NoOp(–ó–≤–æ–Ω–æ–∫ –Ω–∞ {user.full_name})",
                        f"same => n,Dial(PJSIP/{user.sip_username},60,tT)",
                        "same => n,Hangup()",
                        ""
                    ])
            
            # –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∫
            if company_trunks:
                trunk = company_trunks[0]  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç—Ä–∞–Ω–∫
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–∞–Ω–∫ mango-trunk –¥–ª—è Mango Office
                trunk_name = "mango-trunk" if trunk.provider == "mango" else f"trunk_{trunk.id}_{trunk.provider}"
                
                lines.extend([
                    "; –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏",
                    "exten => _X.,1,NoOp(–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫: ${EXTEN})",
                    "same => n,Set(CALLERID(num)=${CALLERID(num)})",
                    f"same => n,Dial(PJSIP/${{EXTEN}}@{trunk_name},60,tT)",
                    "same => n,Hangup()",
                    "",
                    ""
                ])
            
            # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ —Å —Ç—Ä–∞–Ω–∫–∞
            for trunk in company_trunks:
                lines.append(f"[from_trunk_{trunk.id}]")
                lines.append(f"; –í—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏: {company.name}")
                
                # –ù–∞—Ö–æ–¥–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–∞–Ω–∫–∞
                trunk_numbers = [pn for pn in phone_numbers if pn.trunk_id == trunk.id]
                
                if trunk_numbers:
                    for phone_number in trunk_numbers:
                        # –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
                        target_user = None
                        if phone_number.assigned_user_id:
                            target_user = next((u for u in company_users if u.id == phone_number.assigned_user_id), None)
                        
                        if not target_user and company_users:
                            target_user = company_users[0]  # –ü–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
                        
                        if target_user:
                            lines.extend([
                                f"exten => {phone_number.number},1,NoOp(–í—Ö–æ–¥—è—â–∏–π –Ω–∞ {phone_number.display_name or phone_number.number})",
                                f"same => n,Set(CALLERID(name)={phone_number.display_name or 'Client'})",
                                f"same => n,Set(COMPANY_ID={company.id})",
                                f"same => n,Set(TRUNK_ID={trunk.id})",
                            ])
                            
                            # AI –∞–≥–µ–Ω—Ç (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
                            if company.ai_enabled:
                                lines.extend([
                                    f"same => n,AGI(agi://{settings.asterisk_host}:{settings.api_port}/agi/call_start)",
                                ])
                            
                            lines.extend([
                                f"same => n,Dial(PJSIP/{target_user.sip_username},60,tT)",
                                "same => n,Hangup()",
                                ""
                            ])
                else:
                    # –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤, –ø—Ä–∏–Ω–∏–º–∞–µ–º –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ
                    if company_users:
                        target_user = company_users[0]
                        lines.extend([
                            "exten => _X.,1,NoOp(–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫)",
                            f"same => n,Set(COMPANY_ID={company.id})",
                            f"same => n,Set(TRUNK_ID={trunk.id})",
                        ])
                        
                        if company.ai_enabled:
                            lines.extend([
                                f"same => n,AGI(agi://{settings.asterisk_host}:{settings.api_port}/agi/call_start)",
                            ])
                        
                        lines.extend([
                            f"same => n,Dial(PJSIP/{target_user.sip_username},60,tT)",
                            "same => n,Hangup()",
                            ""
                        ])
                
                lines.append("")
        
        return "\n".join(lines)
    
    def _save_config(self, filepath: Path, content: str) -> None:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª"""
        try:
            filepath.parent.mkdir(parents=True, exist_ok=True)
            filepath.write_text(content, encoding='utf-8')
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ 644 (rw-r--r--)
            filepath.chmod(0o644)
            
            logger.debug(f"üìù –°–æ—Ö—Ä–∞–Ω–µ–Ω: {filepath}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è {filepath}: {e}")
            raise
    
    def reload_asterisk(self) -> dict:
        """
        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Asterisk —á–µ—Ä–µ–∑ Docker
        
        Returns:
            dict: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        """
        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É reload –≤ Asterisk CLI —á–µ—Ä–µ–∑ docker exec
            result = subprocess.run(
                ["docker", "exec", "telephony-asterisk", "asterisk", "-rx", "core reload"],
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode == 0:
                logger.info("‚úÖ Asterisk –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ")
                return {
                    "status": "success",
                    "message": "Asterisk configuration reloaded",
                    "output": result.stdout.strip()
                }
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Asterisk: {result.stderr}")
                return {
                    "status": "error",
                    "message": "Failed to reload Asterisk",
                    "error": result.stderr
                }
                
        except subprocess.TimeoutExpired:
            logger.error("‚ùå Timeout –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ Asterisk")
            return {
                "status": "error",
                "message": "Asterisk reload timeout"
            }
        except FileNotFoundError:
            logger.error("‚ùå Docker –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ docker –¥–æ—Å—Ç—É–ø–µ–Ω –≤ PATH")
            return {
                "status": "error",
                "message": "Docker command not found. Make sure docker is available in PATH."
            }
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: {e}")
            return {
                "status": "error",
                "message": str(e)
            }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
config_generator = AsteriskConfigGenerator()
