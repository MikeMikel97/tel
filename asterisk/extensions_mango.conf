; ============================================
; ДИАЛПЛАН ДЛЯ MANGO OFFICE + AI AGENT
; Добавить в /etc/asterisk/extensions.conf
; ============================================

; === Входящие звонки от Mango ===
[from-mango]
; Входящий звонок на номер 79918987423
exten => _X.,1,NoOp(=== INCOMING CALL FROM MANGO ===)
same => n,NoOp(Caller: ${CALLERID(num)}, Called: ${EXTEN})
same => n,Set(CALL_ID=${UNIQUEID})
same => n,Set(CALL_START=${EPOCH})

; Запись разговора с разделением каналов (для STT)
; -r = входящий канал, -t = исходящий канал
same => n,MixMonitor(/var/spool/asterisk/recording/${CALL_ID}.wav,r(/var/spool/asterisk/recording/${CALL_ID}-in.wav)t(/var/spool/asterisk/recording/${CALL_ID}-out.wav))

; Уведомление AI агента о новом звонке через ARI (временно отключено)
; same => n,AGI(agi://127.0.0.1:4573/call_start?caller=${CALLERID(num)}&id=${CALL_ID})

; Звоним на WebRTC оператора
same => n,Dial(PJSIP/operator,60,tT)
same => n,Hangup()

; Обработка завершения звонка
exten => h,1,NoOp(=== CALL ENDED ===)
; same => n,AGI(agi://127.0.0.1:4573/call_end?id=${CALL_ID})
same => n,Hangup()


; === Исходящие звонки через Mango ===
[outbound-mango]
; Звонок на мобильные (9XXXXXXXXX)
exten => _9XXXXXXXXX,1,NoOp(=== OUTGOING CALL VIA MANGO ===)
same => n,Set(CALLERID(num)=79918987423)
same => n,Set(CALL_ID=${UNIQUEID})
same => n,MixMonitor(/var/spool/asterisk/recording/${CALL_ID}.wav,r(/var/spool/asterisk/recording/${CALL_ID}-in.wav)t(/var/spool/asterisk/recording/${CALL_ID}-out.wav))
; same => n,AGI(agi://127.0.0.1:4573/call_start?caller=${CALLERID(num)}&id=${CALL_ID})
same => n,Dial(PJSIP/7${EXTEN}@mango-trunk,60,tT)
same => n,Hangup()

exten => h,1,NoOp(=== CALL ENDED ===)
; exten => h,1,AGI(agi://127.0.0.1:4573/call_end?id=${CALL_ID})
same => n,Hangup()

; Звонок на городские (495XXXXXXX, 499XXXXXXX etc)
exten => _[2-8]XXXXXXXXX,1,NoOp(=== OUTGOING LANDLINE CALL ===)
same => n,Set(CALLERID(num)=79918987423)
same => n,Set(CALL_ID=${UNIQUEID})
same => n,MixMonitor(/var/spool/asterisk/recording/${CALL_ID}.wav)
; same => n,AGI(agi://127.0.0.1:4573/call_start?caller=${CALLERID(num)}&id=${CALL_ID})
same => n,Dial(PJSIP/7${EXTEN}@mango-trunk,60,tT)
same => n,Hangup()


; === Обновленный internal контекст ===
[internal]
; Звонки между внутренними номерами (1001-1099)
exten => _10XX,1,NoOp(Internal call to ${EXTEN})
same => n,Dial(PJSIP/${EXTEN},30)
same => n,Hangup()

; Эхо-тест
exten => 600,1,Answer()
same => n,Echo()
same => n,Hangup()

; Тест записи
exten => 601,1,Answer()
same => n,MixMonitor(/var/spool/asterisk/recording/test-${UNIQUEID}.wav)
same => n,Playback(tt-monkeys)
same => n,Echo()
same => n,Hangup()

; Исходящие звонки — перенаправляем в outbound-mango
exten => _9XXXXXXXXX,1,Goto(outbound-mango,${EXTEN},1)
exten => _[2-8]XXXXXXXXX,1,Goto(outbound-mango,${EXTEN},1)
