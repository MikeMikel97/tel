# 🏗️ АРХИТЕКТУРА СИСТЕМЫ - КАК ЭТО РАБОТАЕТ

## 📞 Путь звонка от клиента до AI-подсказок

```
┌─────────────┐
│   КЛИЕНТ    │ 📱 Звонит на +7 (991) 898-74-23
└──────┬──────┘
       │ SIP звонок
       ▼
┌─────────────────────────────────────────────────────────────┐
│                    MANGO OFFICE                              │
│  (Облачная телефония, твой провайдер связи)                 │
│                                                              │
│  • Принимает звонок из телефонной сети (GSM/VoIP)          │
│  • Имеет твой номер: +7 (991) 898-74-23                    │
│  • Маршрутизирует на твой SIP Trunk                        │
└──────────────────────────┬──────────────────────────────────┘
                           │ SIP протокол (через интернет)
                           │ Адрес: vpbx400362386.mangosip.ru
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              ASTERISK (твой VPS сервер)                      │
│              IP: 155.212.184.103                            │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. SIP TRUNK (подключение к Mango)                  │   │
│  │    • Регистрируется на Mango как абонент            │   │
│  │    • Принимает входящие звонки                       │   │
│  │    • Файл: /etc/asterisk/pjsip.conf                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. ДИАЛПЛАН (логика обработки звонков)             │   │
│  │    • Куда направить звонок (на номер 1001)          │   │
│  │    • Запись разговора в WAV файлы                   │   │
│  │    • Разделение на 2 канала: клиент + оператор     │   │
│  │    • Файл: /etc/asterisk/extensions.conf            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3. ЗАПИСЬ АУДИО                                      │   │
│  │    📁 /var/spool/asterisk/recording/                │   │
│  │    • call123-in.wav   ← голос клиента               │   │
│  │    • call123-out.wav  ← голос оператора             │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 4. ARI (REST API для управления)                    │   │
│  │    • HTTP сервер на порту 8088                      │   │
│  │    • Отправляет события о звонках                   │   │
│  │    • Дает доступ к аудиопотокам                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTP/AGI запросы
                          │ События о звонках
                          ▼
┌─────────────────────────────────────────────────────────────┐
│           AI AGENT BACKEND (твой локальный компьютер)        │
│           FastAPI сервер на порту 8000                       │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. CALL MANAGER (менеджер звонков)                  │   │
│  │    • Получает события от Asterisk                   │   │
│  │    • Управляет активными звонками                   │   │
│  │    • Запускает обработку аудио                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. TRANSCRIPTION SERVICE (транскрипция)             │   │
│  │    • Читает аудио чанки каждые 3 секунды            │   │
│  │    • Отправляет в Soniox API                        │   │
│  │    • Получает текст речи                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3. AI AGENT SERVICE (анализ и подсказки)            │   │
│  │    • Получает транскрипцию                          │   │
│  │    • Анализирует контекст разговора                 │   │
│  │    • Отправляет в OpenRouter (Claude/GPT)           │   │
│  │    • Генерирует подсказки для оператора             │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 4. WEBSOCKET (real-time связь с frontend)           │   │
│  │    • Отправляет события всем подключенным клиентам  │   │
│  │    • События: звонки, транскрипты, подсказки        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────┘
                          │ WebSocket (ws://localhost:8000/ws)
                          ▼
┌─────────────────────────────────────────────────────────────┐
│         WEB ИНТЕРФЕЙС (браузер оператора)                   │
│         http://localhost:3000                               │
│                                                              │
│  ┌────────────────────┬────────────────────────────────┐   │
│  │ Список звонков     │  Активный звонок               │   │
│  │                    │  ┌──────────────────────────┐  │   │
│  │ 📞 +7900123...     │  │ ТРАНСКРИПЦИЯ:            │  │   │
│  │    В разговоре     │  │ Клиент: Это дорого...    │  │   │
│  │    00:45           │  │ Оператор: Понимаю...     │  │   │
│  │                    │  └──────────────────────────┘  │   │
│  │                    │  ┌──────────────────────────┐  │   │
│  │                    │  │ AI ПОДСКАЗКИ:            │  │   │
│  │                    │  │ 💡 Предложи скидку 10%   │  │   │
│  │                    │  │ 💡 Сравни с конкурентами │  │   │
│  │                    │  └──────────────────────────┘  │   │
│  └────────────────────┴────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 ПОСЛЕДОВАТЕЛЬНОСТЬ СОБЫТИЙ

### **Этап 1: Входящий звонок (0 сек)**

```
Клиент → [Набирает +7 991 898-74-23]
   ↓
Телефонная сеть (МТС, Мегафон, etc)
   ↓
Mango Office (облачная АТС)
   ↓
[Проверяет SIP Trunk для этого номера]
   ↓
Asterisk на VPS (регистрация: operator1@vpbx400362386.mangosip.ru)
   ↓
Диалплан [from-mango]: "Входящий на 79918987423 → направить на 1001"
   ↓
AGI скрипт: отправка события в Backend (call_start)
   ↓
Backend создает Call ID и запускает запись
   ↓
WebSocket → Frontend: показать новый звонок в списке
```

### **Этап 2: Оператор отвечает (5 сек)**

```
Softphone оператора (номер 1001) → принял звонок
   ↓
Asterisk: звонок переходит в статус "answered"
   ↓
MixMonitor: начинает записывать 2 отдельных канала:
   • call123-in.wav   (голос клиента)
   • call123-out.wav  (голос оператора)
   ↓
Backend запускает фоновую задачу транскрипции
   ↓
WebSocket → Frontend: обновить статус звонка "В разговоре"
```

### **Этап 3: Разговор и AI анализ (каждые 3 секунды)**

```
┌──────────── Цикл каждые 3 секунды ────────────┐
│                                                │
│ 1. Backend читает новый чанк аудио (3 сек)    │
│    • Клиент: 48000 байт WAV                   │
│    • Оператор: 48000 байт WAV                 │
│                                                │
│ 2. Отправка в Soniox API                      │
│    POST https://api.soniox.com/transcribe     │
│    Body: <audio_bytes>                         │
│    Response: "Это слишком дорого для нас"     │
│                                                │
│ 3. WebSocket → Frontend: показать транскрипт  │
│    "Клиент: Это слишком дорого для нас"       │
│                                                │
│ 4. AI Agent анализирует контекст:             │
│    История последних 10 реплик                 │
│    ↓                                           │
│    POST https://openrouter.ai/api/v1/chat     │
│    {                                           │
│      model: "anthropic/claude-3.5-sonnet",    │
│      messages: [                               │
│        {role: "system", content: "промпт..."},│
│        {role: "user", content: "контекст..."}│
│      ]                                         │
│    }                                           │
│    ↓                                           │
│    Response: {                                 │
│      type: "objection",                        │
│      title: "Возражение: дорого",             │
│      content: "Предложи скидку 10%...",       │
│      priority: "high"                          │
│    }                                           │
│                                                │
│ 5. WebSocket → Frontend: показать подсказку   │
│    💡 [HIGH] Возражение: дорого               │
│    Предложи скидку 10% новым клиентам...      │
│                                                │
└────────────────────────────────────────────────┘
```

### **Этап 4: Завершение звонка**

```
Клиент или оператор положил трубку
   ↓
Asterisk: событие "hangup"
   ↓
Диалплан: exten => h (hangup handler)
   ↓
AGI скрипт: отправка call_end в Backend
   ↓
Backend:
   • Останавливает транскрипцию
   • Удаляет звонок из активных
   • Очищает историю AI
   ↓
WebSocket → Frontend: убрать звонок из списка
```

---

## 🌍 ГДЕ ЧТО НАХОДИТСЯ

### **1. Mango Office (облако)**
- **Что:** SIP провайдер, облачная АТС
- **Где:** Серверы Mango (где-то в России)
- **Зачем:** Принимает звонки из телефонной сети, маршрутизирует на твой Asterisk
- **Управление:** Личный кабинет Mango

### **2. Asterisk (VPS сервер)**
- **Что:** Open-source PBX (мини-АТС)
- **Где:** Beget VPS, IP: 155.212.184.103
- **Зачем:** 
  - Принимает звонки от Mango
  - Звонит операторам (внутренние номера 1001, 1002)
  - Записывает разговоры
  - Управляет телефонией
- **Доступ:** `ssh root@155.212.184.103`

### **3. Backend (твой локальный компьютер)**
- **Что:** Python FastAPI приложение
- **Где:** Твой MacBook (сейчас), потом можно на VPS
- **Зачем:**
  - Получает события от Asterisk
  - Транскрибирует аудио (Soniox)
  - Анализирует через AI (OpenRouter)
  - Отправляет подсказки в браузер
- **Запуск:** `uvicorn app.main:app --port 8000`

### **4. Frontend (браузер оператора)**
- **Что:** HTML + CSS + JavaScript веб-интерфейс
- **Где:** Браузер оператора (Chrome/Safari)
- **Зачем:** Показывает транскрипцию и AI-подсказки в реальном времени
- **Адрес:** http://localhost:3000

### **5. Внешние API (облако)**

**Soniox API:**
- **Что:** Speech-to-Text сервис
- **Где:** api.soniox.com
- **Зачем:** Превращает аудио в текст (русский язык)
- **Оплата:** По количеству минут ($0.005/мин)

**OpenRouter API:**
- **Что:** Прокси к разным LLM (Claude, GPT, etc)
- **Где:** openrouter.ai
- **Зачем:** Анализирует контекст и генерирует подсказки
- **Оплата:** По токенам ($3/1M токенов для Claude)

---

## 🔌 КАК ОНИ ОБЩАЮТСЯ

### **Mango ↔ Asterisk**
```
Протокол: SIP (Session Initiation Protocol)
Порт: 5060 UDP
Направление: двустороннее
Содержимое: 
  • Сигнализация звонков (кто звонит, куда)
  • RTP потоки (само аудио) на портах 10000-20000
```

### **Asterisk → Backend**
```
Протокол: HTTP AGI (Asterisk Gateway Interface)
Порт: 8000
Направление: Asterisk → Backend
Примеры:
  • GET /agi/call_start?caller=79001234567&id=abc123
  • GET /agi/call_end?id=abc123
```

### **Backend ↔ Asterisk (опционально, для real-time)**
```
Протокол: ARI (Asterisk REST Interface)
Порт: 8088
Направление: Backend → Asterisk
Зачем: Управлять звонками, получать аудио в реальном времени
```

### **Backend → Soniox**
```
Протокол: HTTPS REST API
URL: https://api.soniox.com/
Направление: Backend → Soniox
Содержимое: 
  • Отправка: WAV аудио (16kHz, mono, 3 секунды)
  • Получение: JSON с текстом транскрипции
```

### **Backend → OpenRouter**
```
Протокол: HTTPS REST API
URL: https://openrouter.ai/api/v1/chat/completions
Направление: Backend → OpenRouter
Содержимое:
  • Отправка: История разговора + промпт
  • Получение: JSON с подсказкой
```

### **Backend ↔ Frontend**
```
Протокол: WebSocket (ws://)
Порт: 8000
Направление: двустороннее, но в основном Backend → Frontend
Содержимое: JSON события
  • call_start / call_end
  • transcript (транскрипция)
  • suggestion (AI подсказка)
```

---

## 💾 ХРАНЕНИЕ ДАННЫХ

### **Временные данные (оперативная память Backend)**
```python
{
  "call_abc123": {
    "caller": "+79001234567",
    "status": "answered",
    "transcripts": [...],      # последние 10 реплик
    "suggestions": [...]       # все подсказки
  }
}
```

### **Постоянные данные (файлы на VPS)**
```
/var/spool/asterisk/recording/
├── abc123.wav        # полная запись
├── abc123-in.wav     # только клиент
└── abc123-out.wav    # только оператор
```

---

## ⚡ ПОЧЕМУ ИМЕННО ТАК

### **Зачем Mango, если есть Asterisk?**
- Mango дает тебе **реальный телефонный номер** (+7 991...)
- Asterisk **не может** напрямую принимать звонки из GSM сети
- Mango = мост между обычной телефонией и твоим VoIP сервером

### **Зачем Asterisk, если есть Mango?**
- Mango — закрытая система, нет доступа к аудио в реальном времени
- Asterisk дает **полный контроль**: запись, скрипты, интеграции
- Можно делать сложную логику обработки звонков

### **Зачем Backend отдельно от Asterisk?**
- Asterisk умеет только телефонию
- Python + FastAPI = удобно для AI/ML интеграций
- Можно запустить на мощной машине с GPU (для будущего)

### **Зачем WebSocket, а не просто HTTP?**
- HTTP = запрос-ответ, надо постоянно опрашивать сервер
- WebSocket = постоянное соединение, сервер сам отправляет данные
- Real-time обновления **без задержек**

---

## 🔒 БЕЗОПАСНОСТЬ

### **Что защищено:**
✅ Asterisk ↔ Mango: SIP аутентификация (логин/пароль)
✅ Backend ↔ Soniox/OpenRouter: HTTPS + API ключи
✅ Frontend ↔ Backend: WebSocket (можно добавить токены)

### **Что НЕ защищено (пока):**
⚠️ Asterisk AGI → Backend: HTTP без шифрования (внутренняя сеть)
⚠️ Frontend: HTTP вместо HTTPS (локальная разработка)

### **Для production добавить:**
- HTTPS для Frontend (Let's Encrypt)
- VPN или firewall между Asterisk и Backend
- Аутентификация пользователей в веб-интерфейсе

---

## 📊 МОНИТОРИНГ

**Где смотреть что происходит:**

1. **Asterisk:** `ssh root@155.212.184.103` → `asterisk -rvvv`
2. **Backend:** Терминал где запущен uvicorn
3. **Frontend:** Browser Developer Tools (F12) → Console
4. **Soniox:** https://console.soniox.com/
5. **OpenRouter:** https://openrouter.ai/activity

---

Теперь понятно как все работает? 🤓
